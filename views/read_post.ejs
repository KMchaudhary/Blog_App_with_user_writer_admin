<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Read post</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <style>
        .reply-btn {
            outline: 0;
            border: none;
            background-color: transparent;
        }
        .reply-btn:hover {
            text-decoration: underline;
        }
        .send-reply-btn {
            white-space: nowrap;
        }
    </style>
</head>
<body>
    <header class="bg-light border-bottom">
        <div class="container py-3"></div>
    </header>

    <main>
        <div class="head bg-primary py-4">
            <div class="container d-flex flex-column align-items-center">
                <h2 class="text-white"><%= post.title %></h2>
                <p id="description" class="text-light fs-6 md:w-75 md:mx-auto"><%= post.description %></p>
            </div>            
        </div>

        <article class="container">
            <div id="content" class="py-4 fs-6 md:w-75 md:mx-auto"><%= post.body %></div>
            <hr>
        </article>

        
        <section id="comment-section">
            <div class="container">
                <div class="mb-3">
                    <span class="border-bottom border-3 border-dark pb-1 fw-bold fs-5">Comments:</span>

                    <form id="mainCommentForm" class="mt-3" action="http://localhost:3000/posts/<%= post.post_id %>/comment" method="POST">
                        <div class="mb-3">
                            <div class="d-flex flex-column flex-sm-row justify-content-between align-content-center align-items-sm-start">
                                <input type="hidden" name="post_id" value="<%= post.post_id %>">
                                <textarea class="form-control mb-3" id="comment-msg" name="comment" rows="1" placeholder="Write comment here..."></textarea>
                                <button id="send-comment-btn" class="btn btn-primary m-0 ms-sm-3">Comment</button>
                            </div>                            
                        </div>
                    </form>

                    <% if(typeof(comments) != 'undefined' || !comments) { %>
                        <div class="all-comments">

                            <% comments.forEach(cmt => { %>
                                <div class="comment border px-3 mb-2 pb-2 rounded" data-replyto="<%= cmt.comment_id %>">
                                    <div class="main-comment pt-2">
                                        <div class="user-who-comment mb-1">
                                            <div class="d-flex flex-row">
                                                <div class="image-rounded bg-secondary p-3 rounded-circle"></div>
                                                <span class="ms-3 text fw-bold py-1"><%= cmt.name %></span>
                                            </div>
                                        </div>
                                        <div class="msg"><%= cmt.message %></div>
                                    </div>                                    
                                    
                                    <div class="main-comment-replies ms-4">
                                        <% cmt.reply.forEach(reply => { %>
                                            <div class="reply bg-light p-2 rounded mb-2">
                                                <div class="user-who-comment mb-2">
                                                    <div class="d-flex flex-row">
                                                        <div class="image-rounded bg-secondary p-3 rounded-circle"></div>
                                                        <span class="ms-3 text fw-bold py-1"><%= reply.name %></span>
                                                    </div>
                                                </div>
                                                <div class="msg">
                                                    <%= reply.message %>
                                                </div>
                                            </div>
                                        <% }) %>
                                    </div>                           
    
                                    <div class="d-flex justify-content-end">
                                        <a class="reply-btn" data-bs-toggle="collapse" href="#collapse_<%= cmt.comment_id %>" role="button" aria-expanded="false" aria-controls="collapse_<%= cmt.comment_id %>">Reply</a>
                                    </div>
                                    
                                    <div class="reply-box collapse mt-2" id="collapse_<%= cmt.comment_id %>">
                                        <textarea class="form-control me-3 mb-3 bg-light" name="comment" placeholder="Write comment here..."></textarea>
                                        <div><button class="send-reply-btn btn btn-primary">Reply</button></div>
                                    </div>                                    
                                </div>    
                            <% }) %>
                            
                        </div>
                    <% } %>
                </div>
            </div>
        </section>

        <div class="hide-elements d-none">
            <div class="comment border px-3 mb-2 pb-2 rounded">
                <div class="main-comment py-2">
                    <div class="user-who-comment mb-1">
                        <div class="d-flex flex-row">
                            <div class="image-rounded bg-secondary p-3 rounded-circle"></div>
                            <span class="ms-3 text fw-bold py-1"><%= user.name %></span>
                        </div>
                    </div>
                    <div class="msg"></div>
                </div>
            </div>         

        </div>
    </main>

    <footer>
        <div class="container">Footer</div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

    <script>
        const comment = document.getElementById('comment-msg');
        const sendCommentBtn = document.getElementById('send-comment-btn');
        const form = document.getElementById('mainCommentForm');
        const commentList = document.querySelector('.all-comments');

        sendCommentBtn.addEventListener('click', sendComment);

        document.addEventListener('click', (e) => {
            if(e.target.classList.contains('send-reply-btn')) sendReply(e);
        })

        function sendComment(e) {
            e.preventDefault();

            const data = {
                comment: comment.value.trim()
            }

            fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                const cmt = document.querySelector('.hide-elements .comment').cloneNode(true);
                cmt.querySelector('.msg').innerText = comment.value.trim();
               
                commentList.insertBefore(cmt, commentList.firstElementChild);
            })
        }
    
        function sendReply(e) {
            const replyMessage = e.target.closest('.reply-box').querySelector('textarea');
            const reply_to = e.target.closest('div.comment').dataset.replyto;
            const data = {
                comment: replyMessage.value.trim(),
                reply_to_comment: reply_to
            }

            fetch(form.action, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(result => {
                console.log('successful');
                // const cmt = document.querySelector('.hide-elements .comment').cloneNode(true);
                // cmt.querySelector('.msg').innerText = comment.value.trim();
               
                // commentList.insertBefore(cmt, commentList.firstElementChild);
            })
        }
    </script>

</body>
</html>